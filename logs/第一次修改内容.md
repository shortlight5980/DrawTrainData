# DrawTrainData 项目第一次修改记录

## 修改时间
2025年12月8日

## 修改内容

### 1. 画笔粗细调节功能

**功能描述**：添加了画笔粗细控制和速度跟随功能

**修改文件**：
- `index.html`：添加了画笔粗细控制面板
- `styles.css`：为新增控制面板添加样式
- `script.js`：实现了画笔粗细控制逻辑

**具体修改点**：
- 在控制面板中添加了画笔粗细滑块（1-10像素）
- 实现了画笔粗细实时显示
- 添加了「画笔粗细跟随速度调整」选项
- 新增了`brushSize`和`speedAdjust`状态变量
- 实现了`calculateBrushSize`函数计算动态画笔大小

### 2. TXT格式保存增强

**功能描述**：扩展了TXT格式的保存选项

**修改文件**：
- `index.html`：添加了TXT格式的两种保存方式选项
- `styles.css`：为TXT选项添加样式
- `script.js`：实现了TXT导出的两种方式

**具体修改点**：
- 添加了「多文件保存」选项：每张图片保存为独立的txt文件
- 添加了「单文件保存（三维数组）」选项：所有图片数据作为三维数组保存
- 实现了根据选择的导出方式生成不同格式的TXT数据

### 3. 画笔改为圆形

**功能描述**：将原来的方形画笔改为圆形画笔

**修改文件**：
- `script.js`：修改了`drawCell`函数

**具体修改点**：
- 将方形绘制区域改为圆形绘制区域
- 计算每个网格点到圆心的距离，只绘制在圆形范围内的点
- 画笔大小即为圆的直径

## 代码修改详情

### index.html 修改

**添加画笔粗细控制面板**：
```html
<!-- 画笔设置区 -->
<div class="section">
    <h3>画笔设置</h3>
    <div class="brush-settings">
        <div class="setting-item">
            <label for="brushSize">画笔粗细：</label>
            <input type="range" id="brushSize" name="brushSize" min="1" max="10" value="1">
            <span id="brushSizeValue">1</span>像素
        </div>
        <div class="setting-item">
            <label for="speedAdjust">
                <input type="checkbox" id="speedAdjust" name="speedAdjust">
                画笔粗细跟随速度调整
            </label>
        </div>
    </div>
</div>
```

**添加TXT导出选项**：
```html
<div id="txtExportOptions" class="txt-export-options" style="display: none;">
    <label>保存方式：</label>
    <div class="radio-group">
        <label>
            <input type="radio" name="txtExportType" value="multiple" checked>
            多文件保存
        </label>
        <label>
            <input type="radio" name="txtExportType" value="single">
            单文件保存（三维数组）
        </label>
    </div>
</div>
```

### styles.css 修改

**添加画笔设置样式**：
```css
/* 画笔设置样式 */
.brush-settings {
    background-color: #f9f9f9;
    padding: 15px;
    border-radius: 8px;
    margin-top: 10px;
}

.setting-item {
    margin-bottom: 10px;
    display: flex;
    align-items: center;
}

.setting-item label {
    margin-right: 10px;
    font-weight: bold;
}

.setting-item input[type="range"] {
    margin: 0 10px;
}
```

**添加TXT导出选项样式**：
```css
/* TXT导出选项样式 */
.txt-export-options {
    background-color: #f9f9f9;
    padding: 15px;
    border-radius: 8px;
    margin-top: 10px;
}

.radio-group {
    display: flex;
    gap: 20px;
    margin-top: 10px;
}
```

### script.js 修改

**添加画笔状态变量**：
```javascript
// 应用状态
const appState = {
    // ... 原有状态 ...
    brushSize: 1, // 画笔粗细
    speedAdjust: false, // 是否跟随速度调整画笔粗细
    lastMousePos: null, // 上一次鼠标位置
    lastMouseTime: 0 // 上一次鼠标移动时间
};
```

**实现画笔粗细控制**：
```javascript
// 画笔大小调整事件处理
function handleBrushSizeChange() {
    appState.brushSize = parseInt(document.getElementById('brushSize').value);
    document.getElementById('brushSizeValue').textContent = appState.brushSize;
}

// 速度调整事件处理
function handleSpeedAdjustChange() {
    appState.speedAdjust = document.getElementById('speedAdjust').checked;
}

// 计算绘画速度并返回当前画笔大小
function calculateBrushSize(currentMousePos) {
    if (!appState.speedAdjust || !appState.lastMousePos) {
        return appState.brushSize;
    }
    
    const now = Date.now();
    const timeDiff = now - appState.lastMouseTime;
    if (timeDiff === 0) return appState.brushSize;
    
    const distance = Math.sqrt(
        Math.pow(currentMousePos.x - appState.lastMousePos.x, 2) +
        Math.pow(currentMousePos.y - appState.lastMousePos.y, 2)
    );
    
    // 计算速度 (像素/毫秒)
    const speed = distance / timeDiff;
    
    // 根据速度调整画笔大小
    const minSize = 1;
    const maxSize = Math.max(10, appState.brushSize * 2);
    let adjustedSize = maxSize - (speed * 5);
    adjustedSize = Math.max(minSize, Math.min(maxSize, adjustedSize));
    
    return Math.round(adjustedSize);
}
```

**实现TXT导出增强**：
```javascript
// 导出数据集
async function exportDataset() {
    // ... 原有代码 ...
    if (format === 'bmp') {
        // 原有BMP导出代码
    } else {
        // 导出为TXT
        const txtExportType = document.querySelector('input[name="txtExportType"]:checked').value;
        
        if (txtExportType === 'multiple') {
            // 保存为多个TXT文件
            for (let i = 0; i < appState.imageGallery.length; i++) {
                const image = appState.imageGallery[i];
                const txtContent = JSON.stringify(image.data);
                zip.file(`image_${i}.txt`, txtContent);
            }
        } else {
            // 保存为一个TXT文件，使用三维数组
            const allImagesData = [];
            for (const image of appState.imageGallery) {
                allImagesData.push(image.data);
            }
            const txtContent = JSON.stringify(allImagesData);
            zip.file('dataset.txt', txtContent);
        }
    }
    // ... 原有代码 ...
}
```

**画笔改为圆形**：
```javascript
// 绘制单元格
function drawCell(e) {
    // ... 原有代码 ...
    
    // 绘制圆形区域
    const radius = currentBrushSize / 2;
    
    // 计算需要绘制的网格范围
    const minX = Math.max(0, Math.floor(gridX - radius));
    const maxX = Math.min(appState.currentImageSize.width - 1, Math.ceil(gridX + radius));
    const minY = Math.max(0, Math.floor(gridY - radius));
    const maxY = Math.min(appState.currentImageSize.height - 1, Math.ceil(gridY + radius));
    
    for (let y = minY; y <= maxY; y++) {
        for (let x = minX; x <= maxX; x++) {
            // 计算该网格点到圆心的距离
            const distance = Math.sqrt(Math.pow(x - gridX, 2) + Math.pow(y - gridY, 2));
            
            // 如果距离小于等于半径，则填充该网格点
            if (distance <= radius) {
                appState.currentCanvas[y][x] = 1; // 1表示黑色
                drawSingleCell(x, y);
            }
        }
    }
    
    // ... 原有代码 ...
}
```

## 使用说明

### 画笔粗细控制
1. 使用滑块可以手动调整画笔粗细（1-10像素）
2. 勾选「画笔粗细跟随速度调整」选项后，画笔粗细会根据绘制速度动态变化

### TXT格式导出
1. 选择「TXT」格式后，会显示两种保存方式
2. 选择「多文件保存」：每张图片保存为独立的txt文件
3. 选择「单文件保存（三维数组）」：所有图片数据作为三维数组保存到一个txt文件中

### 圆形画笔
- 画笔现在呈现为圆形，大小即为圆的直径
- 绘制时只有在圆形范围内的像素点才会被填充

## 兼容性
所有修改都与原有功能兼容，不会影响现有的BMP导出和图片夹管理功能。
# DTD(DrawTrainData) 架构设计文档

## 1. 整体架构设计

### 1.1 系统架构
DTD采用前后端一体化的单页面应用(SPA)架构，所有功能在客户端完成，无需服务器端支持。

```
┌───────────────────────────────────────────────────────────┐
│                    用户界面层 (UI Layer)                  │
├─────────┬─────────────┬─────────────┬─────────────────────┤
│ 尺寸选择│    画板     │   操作控制   │     图片夹管理      │
└─────────┴─────────────┴─────────────┴─────────────────────┘
                              │
┌─────────────────────────────▼─────────────────────────────┐
│                  业务逻辑层 (Logic Layer)                 │
├──────────┬────────────┬─────────────┬─────────────────────┤
│ 尺寸验证 │  绘制逻辑   │  数据管理   │     导出处理        │
└──────────┴────────────┴─────────────┴─────────────────────┘
                              │
┌─────────────────────────────▼─────────────────────────────┐
│                  数据存储层 (Storage Layer)               │
├────────────┬─────────────┬─────────────┬──────────────────┤
│LocalStorage│  Canvas数据 │   图片数组  │     文件导出      │
└────────────┴─────────────┴─────────────┴──────────────────┘
```

### 1.2 核心模块设计

#### 1.2.1 尺寸选择模块
- **功能**：处理用户选择或输入的图像尺寸
- **组件**：下拉选择框、自定义宽高输入框
- **逻辑**：
  - 验证输入的宽高是否为正整数
  - 当图片夹有图片时，更改尺寸需弹出确认

#### 1.2.2 画板模块
- **功能**：提供绘制界面和绘制功能
- **组件**：Canvas元素、网格系统
- **逻辑**：
  - 根据选择的尺寸动态生成网格
  - 监听鼠标事件实现绘制功能
  - 处理单元格状态变化

#### 1.2.3 图片夹模块
- **功能**：管理用户绘制的图片集合
- **组件**：图片列表、缩略图展示
- **逻辑**：
  - 存储图片的二维数组数据
  - 生成和显示缩略图
  - 统计图片数量

#### 1.2.4 导出模块
- **功能**：将图片数据导出为指定格式
- **组件**：格式选择、导出按钮
- **逻辑**：
  - 将二维数组转换为BMP图像
  - 将二维数组保存为TXT文件
  - 压缩文件为ZIP包

#### 1.2.5 持久化模块
- **功能**：保存和恢复用户数据
- **组件**：无界面组件
- **逻辑**：
  - 将图片夹数据保存到localStorage
  - 从localStorage加载数据
  - 监听数据变化自动保存

## 2. 技术选型

### 2.1 前端技术栈

| 技术/框架 | 版本 | 用途 | 理由 |
|----------|------|------|------|
| HTML5    | -    | 页面结构 | 提供Canvas元素和现代表单控件 |
| CSS3     | -    | 页面样式 | 支持Flex布局和响应式设计 |
| JavaScript (ES6+) | - | 业务逻辑 | 原生JS实现所有功能，无需额外依赖 |
| Canvas API | - | 绘制功能 | 高效的2D绘图能力，支持鼠标交互 |

### 2.2 第三方库

| 库名 | 版本 | 用途 | 理由 |
|------|------|------|------|
| JSZip | ^3.10.1 | 文件压缩 | 客户端生成ZIP文件，支持多格式导出 |
| FileSaver.js | ^2.0.5 | 文件下载 | 客户端触发文件下载，支持多种浏览器 |

### 2.3 存储技术

| 技术 | 用途 | 容量限制 |
|------|------|----------|
| localStorage | 持久化存储用户数据 | 约5MB，足够存储大量二值化图像数据 |

### 2.4 浏览器兼容性

| 浏览器 | 最低版本 |
|--------|----------|
| Chrome | 60+ |
| Firefox | 55+ |
| Safari | 12+ |
| Edge | 79+ |

## 3. 数据结构设计

### 3.1 图片数据结构
```javascript
// 单个图片数据
{
  id: String,        // 唯一标识符
  width: Number,     // 宽度(像素数)
  height: Number,    // 高度(像素数)
  data: Array,       // 二维数组，0=白，1=黑
  createdAt: Date    // 创建时间
}

// 图片夹数据
{
  images: Array,     // 图片数据数组
  imageSize: Object, // 当前选择的图片尺寸
  lastModified: Date // 最后修改时间
}
```

### 3.2 localStorage存储结构
```javascript
{
  "dtd-workspace": {
    "images": [
      {
        "id": "img_1623456789012",
        "width": 32,
        "height": 32,
        "data": [[0, 0, 1, ...], [0, 1, 0, ...]],
        "createdAt": "2023-01-01T12:00:00Z"
      }
    ],
    "imageSize": {
      "width": 32,
      "height": 32
    },
    "lastModified": "2023-01-01T12:05:00Z"
  }
}
```

## 4. 关键功能实现思路

### 4.1 Canvas绘制实现
1. 创建Canvas元素并设置合适的尺寸
2. 根据选择的图像大小计算单元格大小
3. 绘制网格线
4. 监听鼠标事件(mousedown, mousemove, mouseup)
5. 根据鼠标位置计算当前单元格坐标
6. 切换单元格状态并重新绘制

### 4.2 图片导出为BMP
1. 创建临时Canvas
2. 根据二维数组数据绘制像素
3. 使用Canvas API的toDataURL方法获取图像数据
4. 转换为BMP格式
5. 添加到ZIP文件

### 4.3 数据持久化
1. 定义数据存储键名
2. 实现数据保存函数：将图片夹数据转为JSON并保存到localStorage
3. 实现数据加载函数：从localStorage读取JSON并解析
4. 在关键操作点(添加图片、更改尺寸等)调用保存函数

## 5. 性能优化考虑

### 5.1 Canvas绘制优化
- 使用requestAnimationFrame减少重绘次数
- 仅重绘变化的单元格，不重绘整个Canvas
- 合理设置Canvas尺寸，避免过大

### 5.2 内存管理
- 定期清理不再需要的临时对象
- 限制图片夹最大图片数量(可配置)
- 优化图片缩略图生成，减少内存占用

### 5.3 响应式设计
- 使用Flex布局实现自适应界面
- 根据屏幕尺寸调整元素大小和位置
- 确保在移动设备上有良好的使用体验
